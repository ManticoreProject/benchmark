#!/bin/bash
#
# COPYRIGHT (c) 2019 The Manticore Project (http://manticore.cs.uchicago.edu)
# All rights reserved.
#
# Argument is benchmark name.
#

NAME=$1
if [ "$NAME" == "" ]; then
    echo "error: provide the name of the benchmark as first argument"
    exit
fi
INPUT=$2
NUM_TRIALS=$3
USE_MLTON=$4
BINARY_NAME=$5

# if not provided, assume it's mc-seq
if [ -z "$BINARY_NAME" ]; then
  BINARY_NAME="mc-seq"
fi

# DESCRIPTION="BACKEND TEST"
SCRIPT_FILE="seq-cont-test.sh"

RUN_ONE="run-test.sh"

MANTI_BENCH_ROOT=@MANTI_BENCH_ROOT@
SMLNJ_HEAP_FILENAME="smlnj.@SMLNJ_ARCH@-@SMLNJ_OPSYS@"

rm -rf $SCRIPT_FILE $RUN_ONE
touch $SCRIPT_FILE $RUN_ONE

# because the multi-line strings below want to do substitutions,
# we wrap the intended string so it's substituted. the prefix "HACK"
# means we're wrapping that variable so it's not subsituted at the wrong time.
HACK1='$1'
HACK2='$2'
HACK_OPT_LVL='$OPT_LVL'
HACK_DESCRIP='$DESCRIP'

(
cat <<EOF
#!/bin/bash

BACKEND=$HACK1
DESCRIP="${HACK2}-${BINARY_NAME}"
$MANTI_BENCH_ROOT/scripts/gen-makefile.sh
make clean
make $BINARY_NAME
$MANTI_BENCH_ROOT/scripts/experiment-git.sh -f $BINARY_NAME -e -n $NAME -d $HACK_DESCRIP -t $NUM_TRIALS -s "$INPUT"

EOF
) >> $RUN_ONE

(
cat <<EOF
#!/bin/bash

OPT_LVL="-O0"

./run-test.sh "$HACK_OPT_LVL" "cps"

./run-test.sh "$HACK_OPT_LVL -linkstack" "linkstack"
./run-test.sh "$HACK_OPT_LVL -linkstack -noras" "linkstack-noras"

./run-test.sh "$HACK_OPT_LVL -contigstack" "contig"
./run-test.sh "$HACK_OPT_LVL -contigstack -noras" "contig-noras"

./run-test.sh "$HACK_OPT_LVL -segstack" "segstack"
./run-test.sh "$HACK_OPT_LVL -segstack -sealingcapture" "segstack-sealingcapture"
./run-test.sh "$HACK_OPT_LVL -segstack -noras" "segstack-noras"

./run-test.sh "$HACK_OPT_LVL -resizestack" "resizestack"
./run-test.sh "$HACK_OPT_LVL -resizestack -sealingcapture" "resizestack-sealingcapture"
./run-test.sh "$HACK_OPT_LVL -resizestack -noras" "resizestack-noras"

if [ "$USE_MLTON" == "true" ]; then
  ################
  # test mlton
  make clean
  make mlton mlton-profile
  $MANTI_BENCH_ROOT/scripts/experiment-mlton.sh -f mlton -n $NAME -d "mlton" -t $NUM_TRIALS -s "$INPUT"
fi

###############
# test SML/NJ
make clean
make smlnj
$MANTI_BENCH_ROOT/scripts/experiment-smlnj.sh -f $SMLNJ_HEAP_FILENAME -n $NAME -d "smlnj" -t $NUM_TRIALS -s "$INPUT"

EOF
) >> $SCRIPT_FILE

chmod +x $SCRIPT_FILE
chmod +x $RUN_ONE
